# SQL 응용

## DDL(Data Define Language)

DDL(데이터 정의어)는 DB구조, 데이터  형식, 접근 방식 등 DB를 구축하거나 수정할 목적으로 사용하는 언어이다.

- DDL은 번역한 결과가 데이터 사전(Data Dictionary)라는 특별한 파일에 여러 개의 테이블로서 저장된다.
- DDL에는 create schema, create domain, create table, create view, create index, alter table, drop등이 있다.

### CREATE SCHEMA

```sql
create schema 스키마 명 authorization 사용자_id;
```

스키마 정의 명령문

- 스키마의 식명을 위해 스키마 이름이나 소유권자나 허가권자 정의



### CREATE DOMAIN

```sql
create domain 도메인 명 [as] 데이터_타입 
       [default 기본값]
       [constraint 제약조건명 check (범위값)];
```

도메인을 정의하는 명령문

- 임의의 속성에서 취할 수 있는 값의 범위가 sql에서 지원하는 전체 데이터 타입의 값이 아니고 일부분일 때, 사용자는 그 값의 범위를 도메인으로 정의할 수 있다.
- 정의된 도메인명은 일반적인 데이터 타입처럼 사용된다.



### CREATE TABLE

```sql
create table 테이블명 
	    (속성명 데이터_타입 [default 기본값][NOT NULL], ···
		[, primary key(기본키_속성명, ···)]
		[, unique(대체키_속성명, ···)]
		[, foreign key(외래키_속성명, ···)
				references 참조테이블(기본키_속성명, ···)]
				[on delete 옵션]
				[on update 옵션]
		[, constraint 제약조건명][check (조건식)]);
```

테이블을 정의하는 명령문

- 기본 테이블에 포함될 모든 속성에 대하여 속성명과 그 속성의 데이터 타입, 기본값, NOT NULL여부를 지정
- primary key : 기본키로 사용할 속성 또는 속성의 집합 지정
- unique : 대체키로 사용할 속성 또는 속성의 집합을 지정. unique로 지정된 속성은 중복된 값을 가질 수 없다.
- foreign key~ references~ : 참조할 다른 테이블과 그 테이블을 참조할 때 사용할 외래키 속성 지정, 외래키 지정시 참조 무결성의 cascade법칙 적용
  - on delete : 참조 테이블의 튜플이 삭제되었을 때 기본 테이블에 취해야 할 사항을 지정. 옵션에는 no action, cascade, set null, set default
    - no action : 참조 테이블에 변화가 있어도 기본 테이블에는 아무런 조취를 취하지 않는다
    - cascade : 참조 테이블의 튜플이 삭제되면 기본 테이블의 관련 튜플도 모두 삭제, 속성이 변경되면 관련 튜플의 속성 값도 모두 변경
    - set null : 참조 테이블에 변화가 있으면 기본 테이블의 관련 튜플의 속성 값을 Null로 변경
    - set default : 참조 테이블에 변화가 있으면 기본 테이블의 관련 튜플의 속성 값을 기본값으로 변경
- constraint : 제약 조건의 이름을 지정. 이름 지정할 필요가 없으면 check절만 사용하여 속성 값에 대한 제약 조건을 명시
- check : 속성 값에 대한 제약 조건을 정의



#### 다른 테이블을 이용한 테이블 정의

```sql
create table 신규테이블명 as select 속성명[,속성명,···] from 기존테이블명;
```

테이블을 정의하는 명령문



### CREATE VIEW

```SQL
create view 뷰명[(속성명[,속성명,···])] as select 문;
```

뷰를 정의하는 명령문

- select문을 서브쿼리로 사용하여  select문의 결과서로 뷰를 생성한다.
- 서브 쿼리인 select문에는 union이나 order by절 사용할 수 없다.
  - union : 성격이 유사한 두 개의 테이블 데이터를 하나로 만드는 합집합 연산자
- 속성명을 기술하지 않으면 select문의 속성명이 자동으로 사용된다.



### CREATE INDEX

```SQL
create [unique] index 인덱스명 on 테이블명(속성명[asc|desc][,속성명[asc|desc]])[cluster];
```

인덱스를 정의하는 명령문

- unique
  - 사용된 경우 : 중복 값이 **없는** 속성으로 인덱스 생성
  - 생략된 경우 : 중복 값을 **허용**하는 속성으로 인덱스 생성
- cluser : 사용하면 인덱스가 클러스터드 인덱스로 설정됨
  - 클러스터드 인덱스 : 인덱스 키의 순서에 따라 데이터가 정렬되어 저장되는 방식. 실제 데이터가 순서대로 저장되어 있어 인덱스를 검색하지 않아도 원하는 데이터를 빠르게 찾을 수 있다. 하지만 데이터 삽입, 삭제 발생 시 순서를 유지하기 위해 데이터를 재정렬해야 한다.
  - 넌 클러스터드 인덱스 : 인덱스의 키 값만 정렬되어 있을 뿐 실제 데이터는 정렬되지 않는 방식. 데이터를 검색하기 위해서는 먼저 인덱스를 검색하여 실제 데이터의 위치를 확인해야 하므로 클러스터드 인덱스에 비해 검색 속도가 떨어진다.



### ALTER TABLE

```SQL
alter table 테이블명 add 속성명 데이터_타입 [default '기본값'];
alter table 테이블명 alter 속성명 [set default '기본값'];
alter table 테이블명 drop column 속성명 [cascade];
```

테이블에 대한 정의를 변경하는 명령문

- add : 새로운 속성(열) 추가할 때 사용
- alter : 특정 속성의 Default값을 변경할 때 사용
- drop column : 특정 속성을 삭제할 때 사용



### DROP

```SQL
drop schema 스키마명 [cascade|restricted];
drop domain 도메인명 [cascade|restricted];
drop table 테이블명 [cascade|restricted];
drop view 뷰명 [cascade|restricted];
drop index 인덱스명 [cascade|restricted];
drop constraint 제약조건명;
```

스키마, 도메인, 기본 테이블, 뷰 테이블, 인덱스, 제약 조건 등을 제거하는 명령문



## DCL(Data Control Language)

DCL(데이터 제어어)는 데이터의 보안, 무결성, 회복, 병행 제어 등을 정의하는데 사용하는 언어이다.

- DCL은 데이터베이스관리자(DBA)가 데이터 관리를 목적으로 사용한다.
- DCL에는 grant, revoke, commit, rollback, savepoint 등이 있다.



### GRANT / REVOKE

#### 사용자등급 지정 및 해제

```sql
grant 사용자등급 to 사용자_ID_리스트 [identified by 암호];
revoke 사용자등급 from 사용자_ID_리스트;
```

데이터베이스 관리자(DBMA)가 데이터베이스 사용자에게 권한을 부여하거나 취소성을 위한 명령어이다.

- grant : 권한 부여를 위한 명령어
- revoke : 권한 취소를 위한 명령어

#### 테이블 및 속성에 대한 권한 부여 및 취소

```sql
grant 권한_리스트 on 개체 to 사용자 [with grant option];
revoke [grant option for]권한_리스트 on 개체 from 사용자 [cascade];
```

- 권한 종류 : all, select, insert, default, update, alter 등
- with grant option : 부여받은 권한을 다른 사용자에게 다시 부여할 수 있는 권한 부여
- grant option for : 다른 사용자에게 권한을 부여할 수 있는 권한을 취소
- cascade : 권한 취소 시 권한을 부여받았던 사용자가 다른 사용자에게 부여한 권한도 연쇄적으로 취소



### COMMIT

트랜잭션이 성공적으로 끝나면 데이터베이스가 새로운 일관성(Consistency)상태를 가지기 위해 변경된 모든 내용을 데이터베이스에 반영하여야 하는데, 이때 사용하는 명령이 commit 이다.

- commit 명령을 실행하지 않아도 DML문이 성공적으로 완료되면 자동으로 commit 되고, DML이 실패하면 자동으로 rollback이 되도록 auto commit 가능을 설정할 수 있다.



### ROLLBACK

rollback은 아직 commit 되지 않은 변경된 모든 내용들을 취소하고 데이터베이스를 이전 상태로 되돌리는 명령어이다.

- 트랜잭션 전체가 성공적으로 끝나지 못하면 일부 변경된 내용만 데이터베이스에 반영되는 비일관성(Inconsistency)인 상태를 가질 수 있기 때문에 일부분만 완료된 트랜잭션은 롤백(rollback)되어야 한다.



### SAVEPOINT

savepoint는 트랜잭션 내에 rollback할 위치인 저장점을 지정하는 명령어이다.

- 저장점을 지정할 때는 이름을 부여하며, rollback시 지정된 저장점까지의 트랜잭션 처리 내용이 취소된다.



#### TCL

commit, rollback, savepoint는 트랜잭션을 제어하는 용도로 사용되므로 TCL(Transaction Control Language)로 분류하기도 한다. 하지만 기능을 제어하는 명령이라는 공통점으로 DCL의 일부로 분류하기도 한다.



#### 트랜잭션 (Transaction)

트랜잭션은 데이터베이스에서 하나의 논리적 기능을 수행하기 위한 일련의 연산 집합으로서 작업의 단위가 된다.

트랜잭션은 데이터베이스 관리 시스템에서 회복 및 병행 제어시에 처리되는 작업의 논리적 단위다.

하나의 트랜잭션은 commit 되거나 rollback되어야 한다.



## DML(Data Manipulation Language)

DML(데이터 조작어)는 데이터베이스 사용자가 응용 프로그램이나 질의어를 통해 데이터를 실질적으로 관리하는데 사용되는 언어이다.

- DML은 데이터베이스 사용자와 데이터베이스 관리 시스템 간의 인터페이스를 제공한다.

- DML의 유형

  | 명령문 | 기능                        |
  | ------ | --------------------------- |
  | SELECT | 테이블에서 튜플을 검색      |
  | INSERT | 테이블에 새로운 튜플 삽입   |
  | DELETE | 테이블에서 튜플 삭제        |
  | UPDATE | 테이블에서 튜플의 내용 갱신 |




### 삽입문 (INSERT INTO~)

```sql
insert into 테이블명([속성명1, 속성명2,···])
values (데이터1, 데이터2,···);
```

삽입문은 기본 테이블에 새로운 튜플을 삽입할 때 사용한다.

- **대응하는 속성과 데이터**는 **개수와 데이터 유형이 일치**해야 한다.
- 기본 테이블의 모든 속성을 사용할 때는 속성명을 생략할 수 있다.
- select문을 사용하여 다른 테이블의 검색 결과를 삽입할 수 있다.



### 삭제문 (DELETE FROM~)

```sql
delete from 테이블명 [where 조건];
```

삭제문은 기본 테이블에 있는 튜플들 중에서 특정 튜플(행)을 삭제할 때 사용한다.

- 모든 레코드를 삭제할 때는 where절을 삭제한다.
- 모든 레코드를 삭제하더라도 테이블 구조는 남아 있기 때문에 디스크에서 테이블을 완전히 제거하는 drop과는 다르다.



### 갱신문 (UPDATE~ SET~)

```sql
update 테이블명 set 속성명 = 데이터[, 속성명 = 데이터,···]
[where 조건];
```

갱신문은 기본 테이블에 있는 튜플들 중에서 특정 튜플의 내용을 변경할 때 사용



### 데이터 조작문 (DML)의 네가지 유형

| select(검색)     | select~from~where~       |
| ---------------- | ------------------------ |
| **insert(삽입)** | **insert into~ values~** |
| **delete(삭제)** | **delete~ from~ where~** |
| **update(변경)** | **update~ set~ where~**  |



## DML - SELECT-1

```sql
select [predicate] [테이블명.]속성명[as별칭][,[테이블명.]속성명,···]
		[,그룹함수(속성명)[as 별칭]]
		[,window함수 over (partition by 속성명1, 속성명2,···
						order by 속성명3, 속성명4,···)]
from 테이블명[, 테이블명,···]
[where 조건]
[group by 속성명, 속성명,···]
[having 조건]
[order by 속성명[asc|desc]]
```

- select 절
  - predicate : 불러온 튜플 수를 제한할 명령어를 기술
    - all : 모든 튜플을 검색할 때 지정하는 것, 주로 생략
    - distinct : 중복된 튜플이 있으면 그 중 첫 번째 한 개만 검색
    - distinctrow : 중복된 튜플을 제거하고 한 개만 검색하지만 선택된 속성의 값이 아닌, 튜플 전체를 대상으로 한다.
  - 속성명 : 검색하여 불러올 속성(열) 또는 속성을 이용한 수식을 지정
    - 기본 테이블을 구성하는 모든 속성을 지정할 때는 '*'를 기술
    - 두 개 이상의 테이블을 대상으로 검색할 때는 '테이블명.속성명'으로 표현
  - as : 속성 및 연산의 이름을 다른 제목으로 표시하기 위해 사용
- from 절 : 질의에 의해 검색될 데이터들을 포함하는 테이블명을 기술
- where절 : 검색할 조건 기술, 하위질의 사용 가능
  - 하위질의(sub query) : 조건절에 주어진 질의를 먼저 수행하여 그 검색 결과를 조건절의 피연산자로 사용
- order by : 특정 속성을 기준으로 정렬하여 검색할 때 사용한다.
  - 속성명 : 정렬의 기준이 되는 속성명을 기술
  - [asc|desc] : 정렬 방식으로서 'asc'는 오름차순, 'desc'는 내림차순. 생략시 오름차순으로 지정된다.



#### 조건 연산자 / 연산자 우선 순위

- 조건 연산자

  - 비교 연산자

    | 연산자 | =    | <>        | >    | <    | >=          | <=          |
    | ------ | ---- | --------- | ---- | ---- | ----------- | ----------- |
    | 의미   | 같다 | 같지 않다 | 크다 | 작다 | 크거나 같다 | 작거나 같다 |

  - 논리 연산자 : NOT, AND, OR

  - LIKE 연산자 : 대표 문자를 이용해 지정된 속성의 값이 문자 패턴과 일치하는 튜플을 검색하기위해 사용된다.

    | 대표문자 | %                  | _                  | #                  |
    | -------- | ------------------ | ------------------ | ------------------ |
    | 의미     | 모든 문자를 대표함 | 문자 하나를 대표함 | 숫자 하나를 대표함 |

- 연산자 우선 순위

  | 종류        | 연산자                  | 우선순위               |
  | ----------- | ----------------------- | ---------------------- |
  | 산술 연산자 | x , / , +, -            | → 쪽으로 갈수록 낮아짐 |
  | 관계 연산자 | = , <> , >, >= , < , <= | 모두 같다              |
  | 논리 연산자 | NOT, AND, OR            | → 쪽으로 갈수록 낮아짐 |

  - **산술 → 관계 → 논리 연산자** 순으로 연산자 우선순위가 정해짐





## DML - SELECT-2

```sql
select [predicate] [테이블명.]속성명[as별칭][,[테이블명.]속성명,···]
		[,그룹함수(속성명)[as 별칭]]
		[,window함수 over (partition by 속성명1, 속성명2,···
						order by 속성명3, 속성명4,···)]
from 테이블명[, 테이블명,···]
[where 조건]
[group by 속성명, 속성명,···]
[having 조건]
[order by 속성명[asc|desc]]
```

- 그룹함수 : group by절에 지정된 그룹별로 속성의 값을 집계할 함수를 기술
- window함수 : group by절을 이용하지 않고 속성의 값을 집계할 함수를 기술
  - partition by : window함수가 적용될 범위로 사용할 속성을 지정
  - order by : partition 안에서 정렬 기준으로 사용할 속성을 지정
- group by절 : 특정 속성을 기준으로 그룹화하여 검색할 때 사용. 일반적으로 group by절은 그룹 함수와 함께 사용
- having절 : group by와 함께 사용되며, 그룹에 대한 조건을 지정

### 그룹함수

group by절에 지정된 그룹별로 속성의 값을 집계할 때 사용

- count(속성명) : 그룹별 튜플 수를 구하는 함수
- sum(속성명) : 그룹별 합계를 구하는 함수
- avg(속성명) : 그룹별 평균을 구하는 함수
- max(속성명) : 그룹별 최대값을 구하는 함수
- min(속성명) : 그룹별 최소값을 구하는 함수
- stddev(속성명) : 그룹별 표준편차를 구하는 함수
- variance(속성명) : 그룹별 분산을 구하는 함수
- rollup(속성명, 속성명,···) 
  - 인수로 주어진 속성을 대상으로 그룹별 소계를 구하는 함수
  - 속성의 개수가 n개이면, n + 1레벨까지, **하위 레벨에서 상위 레벨 순**으로 데이터가 집계
- cube(속성명, 속성명,···)
  - rollup과 유사한 형태이나 cube는 인수로 주어진 속성을 대상으로 모든 조합의 그룹별 소계를 구한다
  - 속성의 개수가 n개이면, n<sup>2</sup>레벨까지, **상위 레벨에서 하위 레벨 순**으로 데이터가 집계

### window함수

- group by절을 이용하지 않고 함수의 인수로 지정한 속성을 범위로 하여 속성의 값을 집계
- 함수의 인수로 지정한 속성이 대상 레코드의 범위가 되는데, 이를 윈도우 라고 부른다.
  - row_number() : 윈도우별로 각 레코드에 대한 일련 번호 반환
  - rank() : 윈도우별로 순위를 반환하며, 공동 순위 반영
  - dense_rank() : 윈도우별로 순위를 반환하며, 공동 순위를 무시하고 순위 부여



## 프로시저 (Procedure)

프로시저란 절차형 SQL을 활용하여 특정 기능을 수행하는 일종의 트랜잭션언어로 호출을 통해 실행되어 미리 저장해 놓은 SQL 작업을 수행

- 프로시저를 만들어 데이터베이스에 저장하면 여러 프로그램에서 호출하여 사용할 수 있다.
- 프로시저는 데이터 베이스에 저장되어 수행되기 때문에 스토어드(stored) 프로시저라고도 불린다.
- 프로시저는 시스템의 일일 마감 작업, 일괄(Batch) 작업 등에 주로 사용된다.

**+**

- 절차형 SQL : C, Java등의 프로그래밍 언어와 같이 연속적인 실행이나, 분기, 반복 등의 제어가 가능한 SQL을 의미한다
- 트랜잭션 언어 : 데이터베이스를 조작하고 트랜잭션을 처리하는 언어로, SQL과 TCL이 트랜잭션 언어에 속한다.



## 트리거 (Trigger)

트리거는 데이터베이스 스스템에서 데이터의 삽입, 갱신, 삭제 등의 이벤트가 발생할 때마다 관련 작업이 자동으로 수행되는 절차형 SQL이다.

- 트리거는 데이터베이스에 저장되며, 데이터 변경 및 무결성 유지, 로그 메시지 출력 등의 목적으로 사용된다.
- 트리거의 구문에는 DCL(데이터 제어어)을 사용할 수 없으며, DCL(grant, revoke, commit, rollback, savepoint···) 이 포함된 프로시저나 함수를 호출하는 경우에도 오류가 발생한다.
- 트리거에 오류가 있는 경우 트리거가 처리하는 데이터에도 영향을 미치므로 트리거를 생성할 때 세심한 주의가 필요하다.



## 사용자 정의 함수

사용자 정의 함수는 프로시저와 유사하게 SQL을 사용하여 일련의 작업을 연속적으로 처리하며, 종료 시 처리 결과를 단일값으로 반환하는 절차형 SQL이다.

- 사용자 정의 함수는 데이터베이스에 저장되어 select, insert, delete, update 등 DML문의 호출에 의해 실행된다.
- 사용자 정의 함수는 예약어 RETURN을 통해 값을 반환하기 때문에 출력 파라미터가 없다.
- 사용자 정의 함수는 insert, delete, update를 통한 테이블 조작은 할 수 없고, select를 통한 조회만 할 수 있다.
- 사용자 정의 함수는 프로시저를 호출하여 사용할 수 없다.
- 사용자 정의 함수는 SUM(), AVG() 등의 내장 함수처럼 DML문에서 반환값을 활용하기 위한 용도로 사용된다.

**+**

- 매개변수(**parameter**)란 함수의 정의에서 전달받은 인수를 함수 내부로 전달하기 위해 사용하는 변수를 의미 (def?)



### 프로시저 vs 사용자 정의 함수

| 구분             | 프로시저                   | 사용자 정의 함수 |
| ---------------- | -------------------------- | ---------------- |
| 반환값           | 없거나 1개 이상 가능       | 1개              |
| 파라미터         | 입·출력 가능               | 입력만 가능      |
| 사용 가능 명령문 | DML, DCL                   | SELECT           |
| 호출             | 프로시저, 사용자 정의 함수 | 사용자 정의 함수 |
| 사용 방법        | 실행문                     | DML에 포함       |



## 제어문

절차형 SQL은 '절차형'이라는 말 그대로 SQL명령어가 서술된 순서에 따라 위에서 아래로 차례대로 실행되는데, 제어문은 이러한 진행 순서를 변경하기 위해 사용하는 명령문이다.

- 제어문의 종류에는 IF, LOOP, GOTO 등이 있다.



## 커서(Cursor)

커서는 쿼리문의 처리 결과가 저장되어 있는 메모리 공간을 가리키는 포인터(Pointer)아더,

- 커서는 내부에서 자동으로 생성되어 사용되는 **묵시적 커서**와, 사용자가 직접 정의해서 쓰는 **명시적 커서**가 있다.
- 커서의 수행은 열기(Open), 패치(Fetch), 닫기(Close)의 세 단계로 진행된다.
- **묵시적 커서**는 수행된 쿼리문의 정상적인 수행 여부를 확인하기위해 사용되며, **명시적 커서**는 쿼리문의 결과를 저장하여 사용함으로써 동일한 쿼리가 반복 수행되어 데이터베이스 자원이 낭비되는 것을 방지한다.
